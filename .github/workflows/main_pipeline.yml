name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_ENV: test
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  AWS_REGION: ap-southeast-2
  ECR_BACKEND_REPO: backend-flask
  ECR_FRONTEND_REPO: frontend-react-js

jobs:
  security-and-quality:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4

        # - name: Install Security Tools
        #   run: pip install bandit ansible-lint
        
        # - name: Run Bandit
        #   run: bandit -r ./backend-flask -f json -o bandit-report.json || true
        
        # - name: Lint Ansible Playbooks
        #   run: ansible-lint ./ansible/playbooks/*.yml

        - name: Setup Python & Flake8
          uses: actions/setup-python@v5
          with:
            python-version: '3.12'
        
        - name: Install Flake8
          run: pip install flake8
        
        - name: Run Flake8
          run: |
            flake8 ./backend-flask \
              --exclude=./backend-flask/venv,./backend-flask/.venv \
              --select=E9,F63,F7,F82 \
              --count \
              --show-source \
              --statistics

  test-app-dev:
    needs: security-and-quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services (Build & Run)
        env:
          AWS_DEFAULT_REGION: "us-east-1"
          AWS_ACCESS_KEY_ID: "testing"
          AWS_SECRET_ACCESS_KEY: "testing"
          AWS_COGNITO_USER_POOL_ID: "us-east-1_xxxx"
          AWS_COGNITO_USER_POOL_CLIENT_ID: "testing"
          CONNECTION_STRING: "postgresql://postgres:password@db:5432/webapp"
          PROD_CONNECTION_STRING: "postgresql://postgres:password@db:5432/webapp"
          FRONTEND_URL: "http://localhost:3000"
          BACKEND_URL: "http://localhost:4567"
          PG_DATABASE: "webapp"
          PG_PASSWORD: "password"
        run: |
          docker compose up -d --build
          sleep 10
          docker compose ps

      - name: Run backend tests
        run: |
          docker compose exec -T backend-flask python -m pytest

      - name: Run frontend tests
        run: |
          docker compose exec -T -e CI=true frontend-react-js npm test -- --transformIgnorePatterns "node_modules/(?!axios)/"

      - name: Cleanup
        if: always()
        run: docker compose down -v

  create-ecr:
    needs: test-app-dev
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-southeast-2
      ECR_BACKEND_REPO: backend-flask
      ECR_FRONTEND_REPO: frontend-react-js
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Create Backend ECR Repository
        run: |
          # Check if repo exists, create if not
          if aws ecr describe-repositories --repository-names ${{ env.ECR_BACKEND_REPO }} > /dev/null 2>&1; then
            echo "ECR repository ${{ env.ECR_BACKEND_REPO }} already exists"
          else
            echo "Creating ECR repository: ${{ env.ECR_BACKEND_REPO }}"
            aws ecr create-repository \
              --repository-name ${{ env.ECR_BACKEND_REPO }} \
              --image-tag-mutability IMMUTABLE \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=KMS
            
            echo "Setting lifecycle policy"
            aws ecr put-lifecycle-policy \
              --repository-name ${{ env.ECR_BACKEND_REPO }} \
              --lifecycle-policy-text '{"rules":[{"rulePriority":1,"description":"Keep last 10 images","selection":{"tagStatus":"any","countType":"imageCountMoreThan","countNumber":10},"action":{"type":"expire"}}]}'
          fi
      
      - name: Create Frontend ECR Repository
        run: |
          if aws ecr describe-repositories --repository-names ${{ env.ECR_FRONTEND_REPO }} > /dev/null 2>&1; then
            echo "ECR repository ${{ env.ECR_FRONTEND_REPO }} already exists"
          else
            echo "Creating ECR repository: ${{ env.ECR_FRONTEND_REPO }}"
            aws ecr create-repository \
              --repository-name ${{ env.ECR_FRONTEND_REPO }} \
              --image-tag-mutability IMMUTABLE \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=KMS
            
            aws ecr put-lifecycle-policy \
              --repository-name ${{ env.ECR_FRONTEND_REPO }} \
              --lifecycle-policy-text '{"rules":[{"rulePriority":1,"description":"Keep last 10 images","selection":{"tagStatus":"any","countType":"imageCountMoreThan","countNumber":10},"action":{"type":"expire"}}]}'
          fi

  build-and-scan:
    needs: [test-app-dev, create-ecr]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate Tag
        id: vars
        run: |
          # Generate a tag with Date and Short SHA: 20231027-a1b2c3d
          echo "tag=$(date +%Y%m%d-%H%M)-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Build Docker Image
        run: |
          docker build -t app:${{ steps.vars.outputs.tag }} ./backend-flask

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'app:${{ steps.vars.outputs.tag }}'
          format: 'table'
          exit-code: '1' 
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Push to ECR
        run: |
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          docker tag app:${{ steps.vars.outputs.tag }} $REGISTRY/${{ env.ECR_BACKEND_REPO }}:${{ steps.vars.outputs.tag }}
          docker push $REGISTRY/${{ env.ECR_BACKEND_REPO }}:${{ steps.vars.outputs.tag }}

  build-lambda-packages:
    needs: test-app-dev
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Make build script executable
        run: chmod +x build-lambdas.sh
      
      - name: Build Lambda packages
        run: ./build-lambdas.sh
      
      - name: Upload Lambda packages as artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-packages
          path: |
            ./terraform/post_confirmation.zip
            ./terraform/messaging_stream.zip

  manage-infra:
      needs: build-lambda-packages
      runs-on: ubuntu-latest
      defaults:
        run:
          working-directory: ./terraform
      outputs:
        instance_id: ${{ steps.tf_output.outputs.instance_id }}
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION}}

        TF_VAR_default_region: ${{ secrets.AWS_DEFAULT_REGION}}
        TF_VAR_db_password: ${{ secrets.PG_PASSWORD }}
        TF_VAR_allowed_ip: ${{ secrets.ALLOWED_IP }}
        TF_VAR_admin_ip: "0.0.0.0/0"
        TF_VAR_aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }} 
      steps:
        - uses: actions/checkout@v4

        - name: Download Lambda packages
          uses: actions/download-artifact@v4
          with:
            name: lambda-packages
            path: ./terraform

        - uses: hashicorp/setup-terraform@v3

        # A. IaC Security Scan (Tfsec)
        - name: Run Tfsec
          uses: aquasecurity/tfsec-action@v1.0.0
          with:
            working_directory: ./terraform
            minumum_severity: MEDIUM
            soft_fail: false
            format: sarif

        - name: Terraform Init
          run: terraform init

        - name: Terraform Plan
          run: terraform plan -no-color

        - name: Terraform Apply
          if: github.ref == 'refs/heads/main' && github.event_name == 'push'
          run: terraform apply -auto-approve

        - name: Get Instance ID
          id: tf_output
          if: github.ref == 'refs/heads/main'
          run: |
            ID=$(terraform output -raw instance_id)
            echo "instance_id=$ID" >> $GITHUB_OUTPUT

  # configure-and-deploy:
  #   needs: [manage-infra, build-and-scan]
  #   if: github.ref == 'refs/heads/main'
  #   runs-on: ubuntu-latest
  #   env:
  #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #     AWS_DEFAULT_REGION: $AWS_REGION
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Install Ansible & AWS dependencies
  #       run: |
  #         pip install ansible boto3 botocore
  #         ansible-galaxy collection install community.aws amazon.aws
          
  #         # Install Session Manager Plugin
  #         curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
  #         sudo dpkg -i session-manager-plugin.deb

  #     - name: Create Inventory File
  #       run: |
  #         INSTANCE_ID="${{ needs.manage-infra.outputs.instance_id }}"
  #         echo "[webservers]" > inventory.ini
  #         echo "$INSTANCE_ID ansible_connection=community.aws.aws_ssm ansible_aws_ssm_region=${{ env.AWS_REGION }}" >> inventory.ini
  #         cat inventory.ini

  #     - name: Run Ansible Playbook
  #       run: |
  #         ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
  #         REGISTRY="$ACCOUNT_ID.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          
  #         ansible-playbook -i inventory.ini ./ansible/deploy.yml \
  #           --extra-vars "ecr_registry=$REGISTRY backend_repo=${{ env.ECR_BACKEND_REPO }} backend_tag=latest"