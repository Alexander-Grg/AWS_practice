name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_ENV: test
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_COGNITO_USER_POOL_ID: ${{ secrets.AWS_COGNITO_USER_POOL_ID }}
      AWS_COGNITO_USER_POOL_CLIENT_ID: ${{ secrets.AWS_COGNITO_USER_POOL_CLIENT_ID }}
      CONNECTION_STRING: ${{ secrets.CONNECTION_STRING }}
      PROD_CONNECTION_STRING: ${{ secrets.PROD_CONNECTION_STRING }}
      FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
      BACKEND_URL: ${{ secrets.BACKEND_URL }}
      REACT_APP_BACKEND_URL: ${{ secrets.REACT_APP_BACKEND_URL }}
      PG_DATABASE: ${{ secrets.PG_DATABASE }}
      PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
      REACT_APP_AWS_PROJECT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      REACT_APP_AWS_COGNITO_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      REACT_APP_CLIENT_ID: ${{ secrets.AWS_COGNITO_USER_POOL_CLIENT_ID }}
      REACT_APP_AWS_USER_POOLS_ID: ${{ secrets.AWS_COGNITO_USER_POOL_ID }}

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services (Build & Run)
        run: |
          docker compose up -d --build
          sleep 10
          docker compose ps

      - name: Run backend tests
        run: |
          docker compose exec -T backend-flask python -m pytest || echo "No tests found"

      - name: Run frontend tests
        run: |
          docker compose exec -T frontend-react-js npm test || echo "No tests found"

      - name: Health check
        run: |
          curl -f http://localhost:4567/health || echo "Backend health check failed"
          curl -f http://localhost:3000 || echo "Frontend health check failed"

      - name: Cleanup
        if: always()
        run: docker compose down -v