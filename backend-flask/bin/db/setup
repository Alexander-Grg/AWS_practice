#!/bin/bash
set -e

echo "==== db-setup"

# Load Environment Variables
if [ -f ".env" ]; then
    echo "Loading .env variables..."
    set -a
    source .env
    set +a
else
    echo "ERROR: .env file not found."
    exit 1
fi

if [ -z "$CONNECTION_STRING" ]; then
    export CONNECTION_STRING=$CONNECTION_URL
fi

bin_path="backend-flask/bin"

echo "Stopping backend-flask..."
docker compose stop backend-flask

echo "Running drop..."
source "$bin_path/db/drop"

echo "Running create..."
source "$bin_path/db/create"

echo "Running schema-load..."
source "$bin_path/db/schema-load"

echo "Running seed..."
source "$bin_path/db/seed"

echo "Starting backend-flask..."
docker compose up -d backend-flask

echo "Setup complete."